# Testing & Debugging Guide - New Features (Distichain Integration)\n\nQuesto documento fornisce una guida completa per il testing e il debugging dei nuovi moduli implementati basandosi sull'analisi di Distichain.\n\n## Moduli Testati\n\n1. **Modulo di Verifica Avanzata (KYC/KYB)**\n2. **Modulo di Gestione Ordini (OMS)**\n3. **Modulo di Gestione Logistica**\n4. **Modulo di Ispezione**\n5. **Miglioramenti alla Gestione Prodotti (PIM)**\n\n---\n\n## 1. Modulo di Verifica Avanzata (KYC/KYB)\n\n### Test Unitari Backend\n\n```python\n# tests/test_verification.py\nimport pytest\nfrom app.models.verification import Verification, VerificationStatus\nfrom app.schemas.verification import VerificationCreateSchema\n\ndef test_create_verification(db, test_user):\n    \"\"\"Test creazione di una verifica KYC\"\"\"\n    verification_data = VerificationCreateSchema(\n        verification_type=\"kyc\",\n        full_name=\"John Doe\",\n        date_of_birth=\"1990-01-15\"\n    )\n    # Logica di creazione\n    assert verification.status == VerificationStatus.PENDING\n\ndef test_approve_verification(db, test_user, test_verification):\n    \"\"\"Test approvazione di una verifica\"\"\"\n    # Logica di approvazione\n    assert test_verification.status == VerificationStatus.APPROVED\n    assert test_verification.approved_by_admin_id is not None\n\ndef test_reject_verification(db, test_user, test_verification):\n    \"\"\"Test rifiuto di una verifica\"\"\"\n    # Logica di rifiuto\n    assert test_verification.status == VerificationStatus.REJECTED\n```\n\n### Test API\n\n```bash\n# Test sottomissione verifica\ncurl -X POST http://localhost:8000/api/v1/verification/submit \\\n  -H \"Authorization: Bearer YOUR_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"verification_type\": \"kyc\",\n    \"full_name\": \"John Doe\",\n    \"date_of_birth\": \"1990-01-15\"\n  }'\n\n# Test ottenimento stato verifica\ncurl http://localhost:8000/api/v1/verification/status?verification_type=kyc \\\n  -H \"Authorization: Bearer YOUR_TOKEN\"\n```\n\n### Test Frontend\n\n1. Accedi come utente non verificato\n2. Naviga alla pagina di Verifica\n3. Seleziona \"KYC (Verifica Personale)\"\n4. Compila il modulo con dati validi\n5. Clicca \"Sottometti Verifica\"\n6. Verifica che lo stato cambi a \"PENDING\"\n7. Accedi come admin\n8. Approva la verifica\n9. Verifica che lo stato cambi a \"APPROVED\"\n\n---\n\n## 2. Modulo di Gestione Ordini (OMS)\n\n### Test Unitari Backend\n\n```python\n# tests/test_orders.py\nimport pytest\nfrom app.models.orders import Order, OrderStatus, OrderItem\nfrom app.schemas.orders import OrderCreateSchema\n\ndef test_create_order(db, test_buyer, test_seller):\n    \"\"\"Test creazione di un ordine\"\"\"\n    order_data = OrderCreateSchema(\n        seller_id=test_seller.id,\n        title=\"Coffee Beans Order\",\n        total_amount=1000.00,\n        items=[{\n            \"description\": \"Premium Arabica\",\n            \"quantity\": 100,\n            \"unit\": \"kg\",\n            \"unit_price\": 10.00\n        }]\n    )\n    # Logica di creazione\n    assert order.status == OrderStatus.DRAFT\n    assert order.order_number.startswith(\"ORD-\")\n\ndef test_submit_order(db, test_order):\n    \"\"\"Test sottomissione di un ordine\"\"\"\n    # Logica di sottomissione\n    assert test_order.status == OrderStatus.SUBMITTED\n    assert test_order.submitted_at is not None\n\ndef test_accept_order(db, test_order):\n    \"\"\"Test accettazione di un ordine\"\"\"\n    # Logica di accettazione\n    assert test_order.status == OrderStatus.ACCEPTED\n```\n\n### Test API\n\n```bash\n# Test creazione ordine\ncurl -X POST http://localhost:8000/api/v1/orders/create \\\n  -H \"Authorization: Bearer BUYER_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"seller_id\": 2,\n    \"title\": \"Coffee Beans Order\",\n    \"total_amount\": 1000.00,\n    \"items\": [\n      {\n        \"description\": \"Premium Arabica\",\n        \"quantity\": 100,\n        \"unit\": \"kg\",\n        \"unit_price\": 10.00\n      }\n    ]\n  }'\n\n# Test ottenimento ordine\ncurl http://localhost:8000/api/v1/orders/1 \\\n  -H \"Authorization: Bearer BUYER_TOKEN\"\n\n# Test sottomissione ordine\ncurl -X PUT http://localhost:8000/api/v1/orders/1/submit \\\n  -H \"Authorization: Bearer BUYER_TOKEN\"\n\n# Test accettazione ordine\ncurl -X PUT http://localhost:8000/api/v1/orders/1/accept \\\n  -H \"Authorization: Bearer SELLER_TOKEN\"\n```\n\n### Test Frontend\n\n1. Accedi come buyer (PMI)\n2. Naviga alla pagina \"Gestione Ordini\"\n3. Clicca \"Crea Nuovo Ordine\"\n4. Compila il modulo:\n   - Seleziona un seller\n   - Inserisci titolo e descrizione\n   - Aggiungi voci d'ordine\n   - Inserisci importo totale\n5. Clicca \"Crea Ordine\"\n6. Verifica che l'ordine appaia nella lista con status \"DRAFT\"\n7. Clicca sull'ordine e sottomettilo\n8. Accedi come seller\n9. Vedi l'ordine in sospeso e accettalo\n10. Verifica che lo status cambi a \"ACCEPTED\"\n\n---\n\n## 3. Modulo di Gestione Logistica\n\n### Test Unitari Backend\n\n```python\n# tests/test_logistics.py\nimport pytest\nfrom app.models.logistics import Shipment, ShipmentStatus\n\ndef test_create_shipment(db, test_order):\n    \"\"\"Test creazione di una spedizione\"\"\"\n    shipment_data = {\n        \"order_id\": test_order.id,\n        \"shipper_id\": test_order.seller_id,\n        \"receiver_id\": test_order.buyer_id,\n        \"origin_address\": \"Nairobi, Kenya\",\n        \"origin_country\": \"Kenya\",\n        \"destination_address\": \"Milan, Italy\",\n        \"destination_country\": \"Italy\",\n        \"description\": \"Coffee Beans\",\n        \"weight_kg\": 100,\n        \"value\": 1000.00\n    }\n    # Logica di creazione\n    assert shipment.status == ShipmentStatus.QUOTE_REQUESTED\n\ndef test_request_logistics_quote(db, test_shipment):\n    \"\"\"Test richiesta di quotazione logistica\"\"\"\n    # Logica di richiesta quotazione\n    assert len(test_shipment.quotes) > 0\n```\n\n### Test API\n\n```bash\n# Test creazione spedizione\ncurl -X POST http://localhost:8000/api/v1/logistics/shipments \\\n  -H \"Authorization: Bearer SELLER_TOKEN\" \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"order_id\": 1,\n    \"shipper_id\": 2,\n    \"receiver_id\": 1,\n    \"origin_address\": \"Nairobi, Kenya\",\n    \"origin_country\": \"Kenya\",\n    \"destination_address\": \"Milan, Italy\",\n    \"destination_country\": \"Italy\",\n    \"description\": \"Coffee Beans\",\n    \"weight_kg\": 100,\n    \"value\": 1000.00\n  }'\n```\n\n---\n\n## 4. Modulo di Ispezione\n\n### Test Unitari Backend\n\n```python\n# tests/test_inspection.py\nimport pytest\nfrom app.models.logistics import Inspection, InspectionStatus\n\ndef test_request_inspection(db, test_order):\n    \"\"\"Test richiesta di ispezione\"\"\"\n    inspection_data = {\n        \"order_id\": test_order.id,\n        \"requested_by_id\": test_order.buyer_id,\n        \"inspection_type\": \"quality\",\n        \"description\": \"Quality check for coffee beans\",\n        \"location\": \"Nairobi, Kenya\"\n    }\n    # Logica di creazione\n    assert inspection.status == InspectionStatus.QUOTE_REQUESTED\n```\n\n---\n\n## Checklist di Testing Manuale\n\n### Verifica\n- [ ] Utente può sottomettere verifica KYC\n- [ ] Utente può sottomettere verifica KYB\n- [ ] Admin può visualizzare verifiche in sospeso\n- [ ] Admin può approvare una verifica\n- [ ] Admin può rifiutare una verifica\n- [ ] Utente riceve notifica quando verifica è approvata/rifiutata\n\n### Ordini\n- [ ] Buyer può creare un ordine in stato DRAFT\n- [ ] Buyer può aggiungere multiple voci d'ordine\n- [ ] Buyer può sottomettere un ordine\n- [ ] Seller riceve notifica di nuovo ordine\n- [ ] Seller può visualizzare ordine in sospeso\n- [ ] Seller può accettare un ordine\n- [ ] Ordine crea automaticamente uno smart contract blockchain\n\n### Logistica\n- [ ] Seller può creare una spedizione\n- [ ] Sistema richiede quotazioni da provider logistici\n- [ ] Seller può visualizzare quotazioni ricevute\n- [ ] Seller può selezionare un provider e confermare spedizione\n- [ ] Tracciamento in tempo reale della spedizione\n- [ ] Notifiche quando spedizione cambia stato\n\n### Ispezione\n- [ ] Buyer può richiedere un'ispezione\n- [ ] Sistema richiede quotazioni da provider di ispezione\n- [ ] Buyer può visualizzare quotazioni\n- [ ] Buyer può confermare un'ispezione\n- [ ] Report di ispezione è disponibile dopo completamento\n\n---\n\n## Debugging Comuni\n\n### Errore: \"Verifica non trovata\"\n- Verifica che l'utente abbia già sottomesso una verifica\n- Controlla il database per verificare i record\n\n### Errore: \"Accesso negato\" su ordini\n- Verifica che l'utente sia il buyer o il seller dell'ordine\n- Controlla i token di autenticazione\n\n### Errore: Smart contract non creato\n- Verifica che la connessione blockchain sia attiva\n- Controlla le variabili d'ambiente per RPC URL e chiave privata\n- Verifica il saldo del wallet per le fee di gas\n\n---\n\n## Performance Testing\n\n```bash\n# Test carico API ordini\nab -n 1000 -c 10 http://localhost:8000/api/v1/orders/\n\n# Test carico API verifica\nab -n 1000 -c 10 http://localhost:8000/api/v1/verification/status\n```\n\n---\n\n## Conclusione\n\nQuesto documento fornisce una base solida per il testing e il debugging dei nuovi moduli. Si consiglia di eseguire tutti i test prima di deployare in produzione.\n"
